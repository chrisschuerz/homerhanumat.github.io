---
layout: post
title: "Roctopress:  Configure Your Octopress Blog for R"
date: 2014-04-13 20:00:00
comments: true
categories: [Tech Note]
published:  false
status:  process
---



* will be replaced by TOC
{:toc}

```{r include=FALSE}
opts_chunk$set(tidy=FALSE,fig.width=4.5,fig.height=3.5)
```


## Introduction

This post records how I configured [Octopress](http://octopress.org/) for blogging about [R](http://www.r-project.org/), my favorite statistical programming environment.  It is intended for colleagues and students who would like to begin blogging in a similar vein.  I will assume that you have got Octopress up and running, and that you have chosen to have it hosted by [GitHub Pages](https://pages.github.com/).

I claim little in the way of originality:  most of this post consists of tips I picked up from knowledgeable people on the web.

## Directory House-Keeping

Create the following directories in the Octopress directory:

* `Rmd_sources` (your posts will start here)
* `Rmd_sources_old` (to archive old posts source files)
* `source/images/figure` (your R graphs will be placed here)
* `source/images/cache` (if you cache the results of an expensive computation, the results go here)


## From R Markdown to Markdown

We will adopt the approach of [Jason Breyer](http://jason.bryer.org/posts/2012-12-10/Markdown_Jekyll_R_for_Blogging.html).

In your Octopress directory, place the Jason's R Script (perhaps call it `rmarkdown.r`):

```{r eval=FALSE}
#' This R script will process all R mardown files (those with in_ext file extention,
#' .rmd by default) in the current working directory. Files with a status of
#' 'processed' will be converted to markdown (with out_ext file extention, '.markdown'
#' by default). It will change the published parameter to 'true' and change the
#' status parameter to 'publish'.
#'
#' @param dir the directory to process R Markdown files.
#' @param images.dir the base directory where images will be generated.
#' @param images.url
#' @param out_ext the file extention to use for processed files.
#' @param in_ext the file extention of input files to process.
#' @param recursive should rmd files in subdirectories be processed.
#' @return nothing.
#' @author Jason Bryer <jason@bryer.org>
convertRMarkdown <- function(dir=getwd(), images.dir=dir, 
                             images.url='/images/',
                             out_ext='.markdown', in_ext='.rmd', recursive=FALSE) {
        require(knitr, quietly=TRUE, warn.conflicts=FALSE)
        files <- list.files(path=dir, pattern=in_ext, ignore.case=TRUE, recursive=recursive)
        for(f in files) {
                message(paste("Processing ", f, sep=''))
                content <- readLines(f)
                frontMatter <- which(substr(content, 1, 3) == '---')
                if(length(frontMatter) >= 2 & 1 %in% frontMatter) {
                        statusLine <- which(substr(content, 1, 7) == 'status:')
                        publishedLine <- which(substr(content, 1, 10) == 'published:')
                        if(statusLine > frontMatter[1] & statusLine < frontMatter[2]) {
                                status <- unlist(strsplit(content[statusLine], ':'))[2]
                                status <- sub('[[:space:]]+$', '', status)
                                status <- sub('^[[:space:]]+', '', status)
                                if(tolower(status) == 'process') {
                                        #This is a bit of a hack but if a line has zero length (i.e. a
                                        #black line), it will be removed in the resulting markdown file.
                                        #This will ensure that all line returns are retained.
                                        content[nchar(content) == 0] <- ' '
                                        message(paste('Processing ', f, sep=''))
                                        content[statusLine] <- 'status: publish'
                                        content[publishedLine] <- 'published: true'
                                        outFile <- paste(substr(f, 1, (nchar(f)-(nchar(in_ext)))), out_ext, sep='')
                                        render_markdown(strict=TRUE)
                                        opts_knit$set(out.format='markdown')
                                        opts_knit$set(fig.path="images/")
                                        opts_knit$set(base.dir=images.dir)
                                        opts_knit$set(base.url=images.url)
                                        opts_knit$set(fig.width=3.5,fig.height=3,tidy=FALSE)
                                        try(knit(text=content, output=outFile), silent=FALSE)
                                } else {
                                        warning(paste("Not processing ", f, ", status is '", status,
                                                                 "'. Set status to 'process' to convert.", sep=''))
                                }
                        } else {
                                warning("Status not found in front matter.")
                        }
                } else {
                        warning("No front matter found. Will not process this file.")
                }
        }
        invisible()
}
```




## From R Markdown to HTML

Octopress ships with  `rdiscount` as the converter from markdown to HTML, but to handle math you want another converter.  I played around with `pandoc` for a while, but eventually decided on `kramdown`.

Octopress may be "locked" to a specific older version of `kramdown`, so install that version:

```
gem install kramdown -v 0.13.8
```


Now modify your Gemfile to include `kramdown`.  For example, my Gemfile now looks like:

```
source "https://rubygems.org"

group :development do
  gem 'rake', '~> 0.9'
  gem 'jekyll', '~> 0.12'
  gem 'kramdown', '~> 0.13.8'
  gem 'rdiscount', '~> 2.0.7'
  gem 'pygments.rb', '~> 0.3.4'
  gem 'RedCloth', '~> 4.2.9'
  gem 'haml', '~> 3.1.7'
  gem 'compass', '~> 0.12.2'
  gem 'sass', '~> 3.2'
  gem 'sass-globbing', '~> 1.0.0'
  gem 'rubypants', '~> 0.2.0'
  gem 'rb-fsevent', '~> 0.9'
  gem 'stringex', '~> 1.4.0'
  gem 'liquid', '~> 2.3.0'
  gem 'directory_watcher', '1.4.1'
end

gem 'sinatra', '~> 1.4.2'
```

Also, edit your `_config.yml` file:

```
gems: [ 'kramdown' ]
markdown: kramdown
```


To get MathJax to work, my source is [Zheng Dong](http://blog.zhengdong.me/2012/12/19/latex-math-in-octopress),

Open `source/_includes/custom/head.html` and add the following:

```
<!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

```




## Considerations of Style

Open `octopress/sass/custom/_styles.css` and add:

```
#markdown-toc:before {
  content: "In this Post";
  font-weight: bold;
}
ul#markdown-toc {
  list-style: none;
  float: right;
  @include shadow-box;
  background-color: white;
}



caption {
  font-weight:  bolder;
  text-align:  center;
  margin-bottom:  20px; 
}

figcaption {
  font-weight:  bolder;
  text-align:  center;
  margin-bottom:  30px; 
}

p img {
  display: block;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 10px;
  border-style:  ridge;
  border-color:  teal;
  border-width:  thick;
  padding:  5px 5px 5px 5px;
}

table, th, td
{
border: 1px solid black;
}

td
{
padding:15px;
}

table, td, th
{
border:1px solid green;
}
th
{
background-color: rgb(147,161,161);
color:white;
}

table {
    margin-left:auto; 
    margin-right:auto;
    margin-bottom:  30px;
  }
  

dt {
  display:  block;
  font-weight:  bolder;
  margin-bottom:  15px;
  
}

dd {
  display:  block;
  border-style:  double;
  border-color:  blue;
  border-width:  medium;
  padding:  5px 5px 5px 5px;
  margin-bottom:  15px;
}

dl {
  margin-bottom:  30px;
}
```

Drawback:  your blog will look exactly like my blog.

Notes:

* the table of contents styling was from [Robert Riemann](http://blog.riemann.cc/2013/04/10/table-of-contents-in-octopress/).
* CSS for `caption` and `figcaption` are left over from earlier experiments with `pandoc`, but I'm retaining them in case they come in handy later.



## Producing a Post

Create a new .Rmd document, and put it in `Rmd_sources`.  At the top, make sure you have stuff like this:

```
---
layout: post
title: "Your Title Here in Quotes"
date: 2014-04-17 01:00:00
comments: true
categories: [YourCategoryName]
published:  false
status:  process
---
```

If you want the table of contents that `kramdown` provides, then add the following a couple of lines on down:

```
* will be replaced by TOC
{:toc}
```

It's a good idea to set some chunk options (use `include-FALSE`):

```
opts_chunk$set(tidy=FALSE,fig.width=4.5,fig.height=3.5)
```

All images from all posts end up in the same directory, so when a code chunk results in a graphic give that chunk a unique name (different from all other graph chunks that you will ever produce with this blog).

When you are ready to process run:

```{r eval=FALSE}
source("~/octopress/rmarkdown.r")
```

(This assumes your working directory is your home directory, and that `octopress` is directly under your home.  Modify the path name if this is not the case.)

Then change working directory to `Rmd_sources` and run:

```{r eval=FALSE}
convertRMarkdown()
system("cp figure/* ../source/images/figure")
```

If you created any cache make sure you named the chunks uniquely.  Also you need to run:

```{r eval=FALSE}
system("cp cache/* ../source/images/cache")
```


Finally, get the markdown file into the `source/_posts` directory:

```{r eval=FALSE}
system("cp 2014-04-01-HowToSurviveZombieArmageddonUsingR.markdown ../source/_posts")
```

Then the usual:

```
rake generate
rake preview
```

until it looks good, then

```
rake deploy
```

Then commit your changes and push to Git Hub repository:

```
git add --all
git commit -m "add Zombie Armageddon Survival Guide"
git push origin source
```

## Creating a Topics Feed

Say you produce something you think merits wider distribution, and want to pass it on to a great site like [R-bloggers](http://www.r-bloggers.com/):  then you need to create a category feed.  Here's some help I got from [Matt Harrison](http://hairysun.com/blog/2011/11/09/creating-category-feeds-in-octopress/).

Create the file the `source/YourCategoryName.xml` (make sure to modify occurrences of "YourCategoryName" in what follows to whatever you please):

```
---
layout: nil
---
<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title>{{ site.title | xml_escape }} - YourCategoryName</title>
  <link href="{{ site.url }}/atom.xml" rel="self"/>
  <link href="{{ site.url }}/"/>
  <updated>{{ site.time | date_to_xmlschema }}</updated>
  <id>{{ site.url }}/</id>
  <author>
    <name>{{ site.author | xml_escape }}</name>
    {% if site.email %}
      <email>{{ site.email | xml_escape }}</email>
    {% endif %}
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  {% for post in site.categories.YourCategory.Name limit: 20 %}
  <entry>
    <title>{{ post.title | xml_escape }}</title>
    <link href="{{ site.url }}{{ post.url }}"/>
    <updated>{{ post.date | date_to_xmlschema }}</updated>
    <id>{{ site.url }}{{ post.id }}</id>
    <content type="html">{{ post.content | expand_urls: site.url | xml_escape }}</content>
  </entry>
  {% endfor %}
</feed>
```


## Archive Old R Markdowns

Once you are done publishing a post, move the R Markdown source into the `Rmd_sources_old` directory, so the `ConvertRMarkdown()` function won't keep processing them needlessly.

## Lingering Problems

* `kramdown` differs from `knitr` in how it recognizes math.  If you see odd results, consult the `kramdown` documentation on the web to learn how to really really do it right.  If you want to keep on the R Markdown way, then from time to time you may have to escape certain special characters.
* R-bloggers takes your stuff from a blog feed.  It does not recognize MathJax, so your math won't render.

